<?phpnamespace App\Repository;use App\Entities\ProductStorageAgreement;use Doctrine\ORM\EntityManager;use Doctrine\ORM\EntityRepository;use Doctrine\ORM\Query;class ProductStorageAgreementRepository extends EntityRepository {    /**     * @var string     */    private $class = 'App\Entities\ProductStorageAgreement';    /**     * @var EntityManager     */    private $em;    public function __construct(EntityManager $em) {        $this->em = $em;    }    /**     * create Theory     * @return Theory     */    public function prepareData($data) {        return new ProductStorageAgreement($data);    }    public function create(ProductStorageAgreement $option) {        $this->em->persist($option);        $this->em->flush();        return $option;    }    public function update(ProductStorageAgreement $option, $data) {        if (isset($data['is_form_filled'])) {            $option->setIs_form_filled($data['is_form_filled']);        }        if (isset($data['signature'])) {            $option->setSignature($data['signature']);        }        if (isset($data['data_json'])) {            $option->setData_json($data['data_json']);        }        if (isset($data['pdf'])) {            $option->setPdf($data['pdf']);        }        if (isset($data['externally_filled'])) {            $option->setExternally_filled($data['externally_filled']);        }        $this->em->persist($option);        $this->em->flush();    }    public function ofId($id) {        return $this->em->getRepository($this->class)->findOneBy([                    'id' => $id        ]);    }    public function getAllStorageAgreementsTotal($filter) {        $query = $this->em->createQueryBuilder();        $query->select($query->expr()->count('u.id'))                ->from('App\Entities\ProductStorageAgreement', 'u')                ->where('u.is_form_filled = 1')                ->andWhere('u.seller_id = ' . $filter['id']);        if (isset($filter['start_date_updated']) && isset($filter['end_date_updated'])) {            $query->andWhere(                    $query->expr()->between('u.created_at', ':start', ':end'));            $query->setParameter('start', $filter['start_date_updated']);            $query->setParameter('end', $filter['end_date_updated'] . ' 23:59:59');        }        return $query->getQuery()->getSingleScalarResult();    }    public function getAllStorageAgreements($filter) {        $query = $this->em->createQueryBuilder();        $query->select($query->expr()->count('u.id'))                ->from('App\Entities\ProductStorageAgreement', 'u')                ->where('u.is_form_filled = 1')                ->andWhere('u.seller_id = ' . $filter['id']);        if (isset($filter['start_date_updated']) && isset($filter['end_date_updated'])) {            $query->andWhere(                    $query->expr()->between('u.updated_at', ':start', ':end'));            $query->setParameter('start', $filter['start_date_updated']);            $query->setParameter('end', $filter['end_date_updated'] . ' 23:59:59');        }        $total = $query->getQuery()->getSingleScalarResult();        $query = $this->em->createQueryBuilder();        $query->select('u')                ->from('App\Entities\ProductStorageAgreement', 'u')                ->where('u.is_form_filled = 1')                ->andWhere('u.seller_id = ' . $filter['id']);        if (isset($filter['start_date_updated']) && isset($filter['end_date_updated'])) {            $query->andWhere(                    $query->expr()->between('u.updated_at', ':start', ':end')            );            $query->setParameter('start', $filter['start_date_updated']);            $query->setParameter('end', $filter['end_date_updated'] . ' 23:59:59');        }        $qb = $query->getQuery();        $data = $qb->getResult(Query::HYDRATE_ARRAY);        return array('data' => $data, 'total' => $total);    }    public function getAllSellerAgreementsOfWpSellerId($wp_seller_id) {        $query = $this->em->createQueryBuilder();//        $query->select('pqa.created_at,pqa.is_form_filled,CONCAT(\''.url('./../Uploads/user_agreement_pdf_without_card/').'\', pqa.pdf) AS pdf_link')        $query->select('pqa.created_at,pqa.is_form_filled,(case when (pqa.is_form_filled = 1) then CONCAT(\'' . config('app.url') . '\',\'Uploads/user_agreement_pdf_without_card/\', pqa.pdf) else \'\' end) as pdf_link,pqa.pdf')                ->from('App\Entities\ProductStorageAgreement', 'pqa')                ->leftJoin('pqa.seller_id', 's')                ->where('s.wp_seller_id=:wp_seller_id')                ->setParameter('wp_seller_id', $wp_seller_id);        $qb = $query->getQuery();        $data = $qb->getResult(Query::HYDRATE_ARRAY);        return $data;    }    public function getStorageDateReport($product_quot_id) {        $query = $this->em->createQueryBuilder();        $query->select('pqa.data_json')                ->from('App\Entities\ProductStorageAgreement', 'pqa')                ->where('pqa.is_form_filled = 1');        $query->andWhere(                        $query->expr()->like('pqa.quote_ids_json', ':product_quot_id')                )                ->setParameter('product_quot_id', '%' . $product_quot_id . '%');        $qb = $query->getQuery();        $data = $qb->getResult(Query::HYDRATE_ARRAY);        if (count($data) > 0) {            $jsonData = $data[0]['data_json'];            $parsedData = json_decode($jsonData, true);            return $parsedData['month'] . '/' . $parsedData['day'] . '/20' . $parsedData['year'];        }        return null;    }    public function getAllFilled() {        $query = $this->em->createQueryBuilder();        $query->select('pqa')                ->from('App\Entities\ProductStorageAgreement', 'pqa')                ->where('pqa.is_form_filled=:is_form_filled')                ->setParameter('is_form_filled', 1);        $qb = $query->getQuery();        $data = $qb->getResult(Query::HYDRATE_ARRAY);        return $data;    }    public function getAllOfSellerId($seller_id, $filter = null) {        $is_form_filled = 1;        $query = $this->em->createQueryBuilder();        $query->select($query->expr()->count('pqa.id'))                ->from('App\Entities\ProductStorageAgreement', 'pqa')                ->leftJoin('pqa.seller_id', 's')                ->where('s.id=:id')                ->andWhere('pqa.is_form_filled = :pdf_file')                ->setParameter('id', $seller_id)                ->setParameter('pdf_file', $is_form_filled);        $total = $query->getQuery()->getSingleScalarResult();        $query = $this->em->createQueryBuilder();        $query->select('pqa')                ->from('App\Entities\ProductStorageAgreement', 'pqa')                ->leftJoin('pqa.seller_id', 's')                ->where('s.id=:id')                ->andWhere('pqa.is_form_filled = :pdf_file')                ->setParameter('id', $seller_id)                ->setParameter('pdf_file', $is_form_filled);        if ($filter) {            $query->setMaxResults($filter['length']);            if (isset($filter['last']) && $filter['last'] != 0) {                $query->andWhere('pqa.id > :pqa_id')                        ->setParameter('pqa_id', $filter['last']);            }        }        $qb = $query->getQuery();        $data = $qb->getResult(Query::HYDRATE_ARRAY);        $final_data = [];        $final_data['data'] = $data;        $final_data['total'] = $total;        return $final_data;    }    public function getSellerAllStorageAgreement($wp_seller_id) {        $queryBuilder = $this->em->createQueryBuilder();//        $query = $queryBuilder->select('pqa.created_at,pqa.is_form_filled,(case when (pqa.is_form_filled = 1) then CONCAT(\'' . config('app.url') . '\',\'Uploads/storage_agreement_pdf/\', pqa.pdf) else \'\' end) as pdf_link,pqa.pdf')                ->from('App\Entities\ProductStorageAgreement', 'pqa')                ->leftJoin('pqa.seller_id', 's')                ->where('s.wp_seller_id=:wp_seller_id')                ->andWhere('pqa.is_form_filled = 1')                ->setParameter('wp_seller_id', $wp_seller_id)                ->getQuery();        $data = $query->getResult(Query::HYDRATE_ARRAY);        return $data;    }    public function getAllFilledAgreementsOfSeller($seller_id) {        $qb = $this->em->createQueryBuilder();        $qb->select('psa')                ->from($this->class, 'psa')                ->where('psa.is_form_filled = 1')                ->leftJoin('psa.seller_id', 's')                ->where('s.id=:seller_id')                ->andWhere('psa.is_form_filled = 1')                ->setParameter('seller_id', $seller_id);        return $qb->getQuery()->getResult(Query::HYDRATE_ARRAY);    }}